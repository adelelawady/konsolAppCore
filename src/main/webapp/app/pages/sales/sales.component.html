<div class="container-fluid p-3">
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
    <div class="toast show bg-danger text-white" *ngIf="showError" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <i class="ti ti-alert-circle me-2"></i>
        <strong class="me-auto">تنبيه</strong>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="showError = false"></button>
      </div>
      <div class="toast-body">
        {{ errorMessage }}
      </div>
    </div>
  </div>
  <div class="row g-3">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title m-0">نظام نقاط البيع</h3>
            <div class="card-actions">
              <button class="btn btn-outline-primary" (click)="reloadInvoice()" [disabled]="loading">
                <i class="ti ti-refresh me-1"></i>
                تحديث
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <!-- Search Section -->
          <div class="p-3 bg-light border-bottom">
            <div class="row g-3">
              <div class="col-md-12">
                <jhi-items-search-box
                  [placeholder]="'بحث عن منتج...'"
                  [clickMode]="true"
                  (itemSelected)="onItemSelected($event)"
                  [disabled]="loading"
                  class="w-100"
                >
                </jhi-items-search-box>
              </div>
            </div>
          </div>

          <!-- Loading Indicator -->
          <div *ngIf="loading" class="text-center p-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">جاري التحميل...</span>
            </div>
          </div>

          <!-- Invoice Items Table -->
          <div class="table-responsive" *ngIf="!loading && currentInvoice">
            <table class="table table-vcenter table-hover">
              <thead>
                <tr class="text-center">
                  <th>#</th>
                  <th>المنتج</th>
                  <th>وحدة</th>
                  <th>سعر الوحدة</th>
                  <th>كمية</th>
                  <th>اجمالي</th>
                  <th>خصم</th>
                  <th>صافي</th>
                  <th>اجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of currentInvoice?.invoiceItems || []; let i = index" class="align-middle text-center">
                  <td>{{ i + 1 }}</td>
                  <td class="text-start">{{ item.item?.name || '-' }}</td>
                  <td>{{ item.unit || '-' }}</td>
                  <td>{{ item.price || 0 | appCurrency }}</td>
                  <td>{{ item.qtyOut || 0 | number: '1.3-3' }}</td>
                  <td>{{ item.totalPrice || 0 | appCurrency }}</td>
                  <td>
                    <div [class.text-danger]="(item.discount || 0) > 0">
                      {{ item.discount || 0 | appCurrency }}
                    </div>
                  </td>
                  <td>{{ item.netPrice || 0 | appCurrency }}</td>
                  <td>
                    <div class="btn-list justify-content-center">
                      <button class="btn btn-icon btn-sm btn-ghost-danger" (click)="deleteInvoiceItem(item.id || '')" [disabled]="loading">
                        <i class="ti ti-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <!-- Empty State -->
                <tr *ngIf="!currentInvoice?.invoiceItems?.length">
                  <td colspan="9" class="text-center py-5">
                    <div class="empty">
                      <div class="empty-icon">
                        <i class="ti ti-shopping-cart text-muted" style="font-size: 2rem"></i>
                      </div>
                      <p class="empty-title">لا توجد منتجات</p>
                      <p class="empty-subtitle text-muted">قم بإضافة منتجات إلى السلة للبدء</p>
                    </div>
                  </td>
                </tr>
              </tbody>
              <!-- Table Footer with Totals -->
              <tfoot *ngIf="currentInvoice?.invoiceItems?.length" class="bg-light">
                <tr class="text-center fw-bold">
                  <td colspan="4" class="text-start">الإجمالي</td>
                  <td>{{ getTotalQuantity() | number: '1.3-3' }}</td>
                  <td>{{ currentInvoice?.totalPrice || 0 | appCurrency }}</td>
                  <td>{{ currentInvoice?.discount || 0 | appCurrency }}</td>
                  <td>{{ currentInvoice?.netPrice || 0 | appCurrency }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Keep existing user panel code -->
    <div class="col-lg-3">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">بيع</h3>
        </div>
        <div class="card-body">
          <!-- User Info -->
          <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
            <span class="avatar avatar-lg me-3">
              <img src="/assets/images/placeholder.svg" alt="User Avatar" />
            </span>
            <div class="flex-fill">
              <div class="font-weight-medium">{{ currentInvoice?.created_by || 'USER' }}</div>
              <div class="text-muted small">{{ currentInvoice?.created_date | date: 'HH:mm dd/MM/yyyy' }}</div>
            </div>
            <div class="ms-auto text-end">
              <div class="text-muted small">رقم الفاتورة</div>
              <div class="font-weight-medium">{{ currentInvoice?.pk || 'NA' }}</div>
            </div>
          </div>

          <!-- Store Selection 
          <div class="mb-3">
            <label class="form-label">المخزن</label>
            <select class="form-select" 
                    [(ngModel)]="selectedBankId"
                    (ngModelChange)="onBankChange($event)"
                    [disabled]="loading">
              <option [ngValue]="null">اختر المخزن</option>
              <option *ngFor="let bank of banks" [value]="bank.id">
                {{ bank.name }}
              </option>
            </select>
          </div>

        
          <div class="mb-3">
            <label class="form-label">الحساب</label>
            <select class="form-select" 
                    [(ngModel)]="selectedAccountId"
                    (ngModelChange)="onAccountChange($event)"
                    [disabled]="loading">
              <option [ngValue]="null">اختر الحساب</option>
              <option *ngFor="let account of accounts" [value]="account.id">
                {{ account.name }}
              </option>
            </select>
          </div>
-->
          <!-- Invoice Discount -->
          <div class="mb-3">
            <label class="form-label">خصم على الفاتورة</label>
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                [ngModel]="currentInvoice?.discount || 0"
                (ngModelChange)="onDiscountChange($event)"
                [disabled]="loading"
                min="0"
                step="0.01"
              />
              <span class="input-group-text">ر.س</span>
            </div>
            <small class="text-muted" *ngIf="currentInvoice?.discount"> الخصم: {{ currentInvoice?.discount | appCurrency }} </small>
          </div>

          <!-- Totals Summary -->
          <div class="card bg-primary-subtle mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">الإجمالي قبل الخصم:</span>
                <span class="font-weight-medium">{{ currentInvoice?.totalPrice | number: '1.2-2' }} ر.س</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">الخصم:</span>
                <span class="text-danger">{{ currentInvoice?.discount | number: '1.2-2' }} ر.س</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="font-weight-bold">الإجمالي النهائي:</span>
                <span class="font-weight-bold text-primary h4 mb-0">{{ currentInvoice?.netPrice | number: '1.2-2' }} ر.س</span>
              </div>
            </div>
          </div>

          <!-- Save Button -->
          <button class="btn btn-primary w-100" (click)="saveInvoice()">
            <i class="ti ti-device-floppy me-1"></i>
            حفظ الفاتورة
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
