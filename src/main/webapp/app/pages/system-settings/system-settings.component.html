<div class="container-xl">
  <div class="page-header d-print-none mb-4">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          <i class="ti ti-settings me-2"></i>
          {{ 'systemSettings.title' | translate }}
        </h2>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form [formGroup]="settingsForm" (ngSubmit)="onSubmit()">
        <!-- General Store Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-shop me-2"></i>
              {{ 'systemSettings.sections.general' | translate }}
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-store me-2"></i>
                  {{ 'systemSettings.mainStore' | translate }}
                </label>
                <app-store-selector [selectedStore]="mainStore" (storeSelected)="onMainStoreSelected($event)"></app-store-selector>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-bank me-2"></i>
                  {{ 'systemSettings.mainBank' | translate }}
                </label>
                <app-bank-selector [selectedBank]="mainBank" (bankSelected)="onMainBankSelected($event)"></app-bank-selector>
              </div>
            </div>
          </div>
        </div>

        <!-- Playstation Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-gamepad me-2"></i>
              {{ 'systemSettings.sections.playstation' | translate }}
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-store me-2"></i>
                  {{ 'systemSettings.playstationStore' | translate }}
                </label>
                <app-store-selector
                  [selectedStore]="playstationStore"
                  (storeSelected)="onPlaystationStoreSelected($event)"
                ></app-store-selector>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-bank me-2"></i>
                  {{ 'systemSettings.playstationBank' | translate }}
                </label>
                <app-bank-selector [selectedBank]="playstationBank" (bankSelected)="onPlaystationBankSelected($event)"></app-bank-selector>
              </div>

              <!-- Playstation Printer Settings -->
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="fas fa-print me-2"></i>
                  {{ 'systemSettings.playstationPrinter' | translate }}
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  formControlName="PLAYSTATION_DEFAULT_PRINTER" 
                  placeholder="{{ 'systemSettings.printerPlaceholder' | translate }}"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-check form-switch">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    formControlName="PLAYSTATION_PRINT_ON_CHECKOUT"
                  />
                  <span class="form-check-label">
                    {{ 'systemSettings.printOnCheckout' | translate }}
                  </span>
                </label>
                <small class="form-text text-muted">
                  {{ 'systemSettings.printOnCheckoutHelp' | translate }}
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Inventory Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-boxes me-2"></i>
              {{ 'systemSettings.sections.inventory' | translate }}
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="SALES_CHECK_ITEM_QTY" />
                    <span class="form-check-label">{{ 'systemSettings.checkItemQuantity' | translate }}</span>
                  </label>
                </div>

                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="SALES_UPDATE_ITEM_QTY_AFTER_SAVE" />
                    <span class="form-check-label">{{ 'systemSettings.updateQuantityAfterSale' | translate }}</span>
                  </label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="PURCHASE_UPDATE_ITEM_QTY_AFTER_SAVE" />
                    <span class="form-check-label">{{ 'systemSettings.updateQuantityAfterPurchase' | translate }}</span>
                  </label>
                </div>

                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="ALLOW_NEGATIVE_INVENTORY" />
                    <span class="form-check-label">{{ 'systemSettings.allowNegativeInventory' | translate }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Invoice Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-receipt me-2"></i>
              {{ 'systemSettings.sections.invoice' | translate }}
            </h3>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" formControlName="SAVE_INVOICE_DELETETED_INVOICEITEMS" />
                <span class="form-check-label">{{ 'systemSettings.saveDeletedInvoiceItems' | translate }}</span>
              </label>
            </div>
          </div>
        </div>
        <!-- License Information -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="card-title mb-0">
                <i class="fas fa-key me-2"></i>
                {{ 'systemSettings.sections.license' | translate }}
              </h3>
              <button type="button" class="btn btn-primary btn-sm mx-2" (click)="openLicenseDialog()">
                <i class="fas fa-plus me-2"></i>
                {{ 'systemSettings.license.addLicense' | translate }}
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>{{ 'systemSettings.license.clientId' | translate }}</th>
                    <th>{{ 'systemSettings.license.licenseKey' | translate }}</th>
                    <th>{{ 'systemSettings.license.expiryDate' | translate }}</th>
                    <th>{{ 'systemSettings.license.daysRemaining' | translate }}</th>
                    <th>{{ 'systemSettings.license.statusX' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let license of settings?.license">
                    <td>{{ license.clientId }}</td>
                    <td>{{ license.licenseKey }}</td>
                    <td>{{ license.expiryDate | date: 'mediumDate' }}</td>
                    <td>
                      <span [class]="getLicenseDaysClass(license)">
                        {{ calculateDaysRemaining(license) }}
                      </span>
                    </td>
                    <td>
                      <span [class]="getLicenseStatusClass(license)">
                        {{ getLicenseStatus(license) | translate }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!settings?.license?.length">
                    <td colspan="5" class="text-center">
                      {{ 'systemSettings.license.noLicenses' | translate }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Backup Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-database me-2"></i>
              {{ 'systemSettings.sections.backup' | translate }}
            </h3>
          </div>
          <div class="card-body">
            <!-- Enable Backup -->
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" formControlName="BACKUP_ENABLED" />
                <span class="form-check-label">{{ 'systemSettings.backup.enable' | translate }}</span>
              </label>
            </div>

            <!-- Backup Configuration -->
            <div class="row" *ngIf="settingsForm.get('BACKUP_ENABLED')?.value">
              <!-- Schedule Type -->
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.scheduleType' | translate }}</label>
                <select class="form-select" formControlName="BACKUP_SCHEDULE_TYPE">
                  <option value="DAILY">{{ 'systemSettings.backup.scheduleTypes.daily' | translate }}</option>
                  <option value="WEEKLY">{{ 'systemSettings.backup.scheduleTypes.weekly' | translate }}</option>
                  <option value="MONTHLY">{{ 'systemSettings.backup.scheduleTypes.monthly' | translate }}</option>
                  <option value="MANUAL">{{ 'systemSettings.backup.scheduleTypes.manual' | translate }}</option>
                </select>
              </div>

              <!-- Backup Time -->
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.time' | translate }}</label>
                <input type="time" class="form-control" formControlName="BACKUP_TIME" />
              </div>

              <!-- Weekly Backup Days -->
              <div class="col-md-12 mb-3" *ngIf="settingsForm.get('BACKUP_SCHEDULE_TYPE')?.value === 'WEEKLY'">
                <label class="form-label">{{ 'systemSettings.backup.days' | translate }}</label>
                <div class="d-flex gap-3 flex-wrap">
                  <label class="form-check" *ngFor="let day of weekDays">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [value]="day.value"
                      (change)="onBackupDayChange($event, day.value)"
                      [checked]="isBackupDaySelected(day.value)"
                    />
                    <span class="form-check-label">{{ day.label | translate }}</span>
                  </label>
                </div>
              </div>

              <!-- Retention Period -->
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.retentionDays' | translate }}</label>
                <input type="number" class="form-control" formControlName="BACKUP_RETENTION_DAYS" min="1" />
              </div>

              <!-- Backup Location -->
              <div class="col-md-12 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.location' | translate }}</label>
                <input type="text" class="form-control" formControlName="BACKUP_LOCATION" />
              </div>

              <!-- MongoDB Paths -->
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.mongodbDumpPath' | translate }}</label>
                <input type="text" class="form-control" formControlName="MONGODB_DUMP_PATH" />
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'systemSettings.backup.mongodbRestorePath' | translate }}</label>
                <input type="text" class="form-control" formControlName="MONGODB_RESTORE_PATH" />
              </div>

              <!-- Additional Options -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="BACKUP_INCLUDE_FILES" />
                    <span class="form-check-label">{{ 'systemSettings.backup.includeFiles' | translate }}</span>
                  </label>
                </div>

                <div class="mb-3">
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="BACKUP_COMPRESS" />
                    <span class="form-check-label">{{ 'systemSettings.backup.compress' | translate }}</span>
                  </label>
                </div>
              </div>

              <!-- Backup Actions -->
              <div class="col-12 mt-3">
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-primary" (click)="performBackup()" [disabled]="backupInProgress">
                    <i class="fas fa-database me-2"></i>
                    {{ 'systemSettings.backup.performBackup' | translate }}
                  </button>
                  <button type="button" class="btn btn-secondary" (click)="openRestoreDialog()" [disabled]="restoreInProgress">
                    <i class="fas fa-undo me-2"></i>
                    {{ 'systemSettings.backup.performRestore' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Restore Dialog -->
        <ng-template #restoreDialog>
          <div class="modal-header">
            <h4 class="modal-title">{{ 'systemSettings.backup.restoreTitle' | translate }}</h4>
            <button type="button" class="btn-close" (click)="closeRestoreDialog()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">{{ 'systemSettings.backup.selectBackupPath' | translate }}</label>
              <input type="text" class="form-control" [(ngModel)]="restorePath" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div class="alert alert-warning">
              {{ 'systemSettings.backup.restoreWarning' | translate }}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeRestoreDialog()">
              {{ 'common.cancel' | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="performRestore()" [disabled]="!restorePath">
              {{ 'systemSettings.backup.confirmRestore' | translate }}
            </button>
          </div>
        </ng-template>

        <!-- License Dialog -->
        <ng-template #licenseDialog>
          <div class="modal-header">
            <h4 class="modal-title">{{ 'systemSettings.license.addTitle' | translate }}</h4>
            <button type="button" class="btn-close" (click)="closeLicenseDialog()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">{{ 'systemSettings.license.enterKey' | translate }}</label>
              <input type="text" class="form-control" [(ngModel)]="licenseKey" [ngModelOptions]="{ standalone: true }" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeLicenseDialog()">
              {{ 'common.cancel' | translate }}
            </button>
            <button type="button" class="btn btn-primary" (click)="processLicense()" [disabled]="!licenseKey || processingLicense">
              <i class="fas fa-spinner fa-spin me-2" *ngIf="processingLicense"></i>
              {{ 'systemSettings.license.process' | translate }}
            </button>
          </div>
        </ng-template>

        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-primary" [disabled]="loading || !settingsForm.valid">
            <i class="ti ti-device-floppy me-2"></i>
            {{ 'systemSettings.save' | translate }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
