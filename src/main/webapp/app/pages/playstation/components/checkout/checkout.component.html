<div class="checkout-container">
  <div class="checkout-header">
    <h2>{{ 'playstation.checkout.title' | translate }}</h2>

    <div class="text-center" *ngIf="isUpdating">
      <span class="spinner-border spinner-border-sm"></span>
      <small class="text-muted ms-2">{{ 'playstation.checkout.form.updating' | translate }}</small>
    </div>
    <button class="btn btn-outline-secondary" (click)="cancel()">
      <fa-icon icon="times"></fa-icon>
      <span>{{ 'playstation.checkout.actions.cancel' | translate }}</span>
    </button>
  </div>

  <div class="checkout-content" *ngIf="selectedDevice">
    <div class="session-summary">
      <h3>{{ 'playstation.checkout.summary.title' | translate }}</h3>

      <div class="summary-item" *ngIf="this.selectedDevice?.timeManagement">
        <span>{{ 'playstation.checkout.summary.sessionTime' | translate }}</span>
        <span class="amount">{{ getSessionTimeCost() | currencyK }}</span>
      </div>

      <!-- Previous Sessions Section -->
      <ng-container *ngIf="selectedDevice?.session?.deviceSessions?.length && this.selectedDevice?.timeManagement">
        <div class="previous-sessions-section">
          <div class="section-header">
            <i class="fas fa-history"></i>
            <span
              >{{ 'playstation.checkout.summary.previousSessions' | translate }} ({{
                selectedDevice.session?.deviceSessions?.length
              }})</span
            >
          </div>
          <div class="previous-sessions-list">
            <ng-container *ngIf="selectedDevice?.session?.deviceSessions as deviceSessions">
              <div class="session-item" *ngFor="let prevSession of deviceSessions">
                <div class="session-info">
                  <span class="session-time">{{ prevSession.startTime | date: 'short' }}</span>
                  <div class="session-details">
                    <span class="session-duration">{{ getDuration(prevSession.startTime, prevSession.endTime) }}</span>
                    <span class="session-type">({{ prevSession.type?.name }})</span>
                  </div>
                </div>
                <div class="session-costs">
                  <div class="cost-breakdown">
                    <small class="text-muted"
                      >Time:
                      {{ calculateSessionCost(prevSession.startTime, prevSession.endTime, prevSession.type?.price) | currencyK }}</small
                    >
                    <small class="text-muted" *ngIf="prevSession.invoice?.netPrice"
                      >Orders: {{ prevSession.invoice?.netPrice | currencyK }}</small
                    >
                  </div>
                  <span class="session-cost">{{ getSessionTotalCost(prevSession) | currencyK }}</span>
                </div>
              </div>
            </ng-container>
          </div>
          <div class="previous-sessions-total">
            <span>{{ 'playstation.checkout.summary.previousTotal' | translate }}</span>
            <span
              >{{ selectedDevice.session?.deviceSessionsNetPrice || 0 }} {{ 'playstation.devices.card.session.currency' | translate }}</span
            >
          </div>
        </div>
      </ng-container>

      <div class="summary-item">
        <span>{{ 'playstation.checkout.summary.orders' | translate }}</span>
        <span class="amount">{{ getOrdersTotal() | currencyK }}</span>
      </div>

      <div class="summary-item total">
        <span>{{ 'playstation.checkout.summary.subtotal' | translate }}</span>
        <span class="amount">{{ getTotalBeforeDiscount() | currencyK }}</span>
      </div>
    </div>

    <form [formGroup]="checkoutForm" class="adjustments-form">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label>{{ 'playstation.checkout.form.discount.label' | translate }}</label>
            <input
              type="number"
              class="form-control"
              formControlName="discount"
              [placeholder]="'playstation.checkout.form.discount.placeholder' | translate"
              [class.disabled]="isUpdating"
            />
          </div>

          <div class="form-group">
            <label>{{ 'playstation.checkout.form.additions.label' | translate }}</label>
            <input
              type="number"
              class="form-control"
              formControlName="additions"
              [placeholder]="'playstation.checkout.form.additions.placeholder' | translate"
              [class.disabled]="isUpdating"
            />
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label>{{ 'playstation.checkout.form.notes.label' | translate }}</label>
            <textarea
              class="form-control"
              formControlName="notes"
              rows="3"
              [placeholder]="'playstation.checkout.form.notes.placeholder' | translate"
              [class.disabled]="isUpdating"
            ></textarea>
          </div>
        </div>

        <div class="col-md-12">
          <div class="form-group">
            <label>{{ 'playstation.checkout.form.userNetPrice.label' | translate }}</label>
            <div style="display: flex; align-items: center">
              <input
                style="font-size: x-large"
                type="number"
                class="form-control"
                formControlName="userNetPrice"
                [placeholder]="'playstation.checkout.form.userNetPrice.placeholder' | translate"
                [class.disabled]="isUpdating"
              />
              <button class="btn btn-outline-secondary mx-1" (click)="updateUserNetPriceValue()">
                <fa-icon icon="check"></fa-icon>
                <span>{{ 'playstation.checkout.actions.confirm' | translate }}</span>
              </button>
            </div>

            <small class="text-muted" *ngIf="checkoutForm.get('userNetPrice')?.value !== getFinalTotal()">
              {{ 'playstation.checkout.form.userNetPrice.customized' | translate }}
            </small>
          </div>
        </div>
      </div>
    </form>

    <div class="final-total">
      <h4>{{ 'playstation.checkout.summary.finalTotal' | translate }}</h4>
      <span class="amount">{{ getFinalTotal() | currencyK }}</span>
    </div>

    <div class="checkout-actions">
      <button class="btn btn-danger btn-lg" (click)="endSession()" [disabled]="isProcessing || isUpdating">
        <fa-icon icon="power-off"></fa-icon>
        <span class="spinner-border spinner-border-sm ms-1" *ngIf="isUpdating"></span>
        <span>{{ 'playstation.checkout.actions.endSession' | translate }}</span>
      </button>
      <button class="btn btn-danger btn-lg" (click)="endSessionWithFinalPrice()" [disabled]="isProcessing || isUpdating">
        <fa-icon icon="power-off"></fa-icon>
        <span class="spinner-border spinner-border-sm ms-1" *ngIf="isUpdating"></span>
        <span>{{ 'playstation.checkout.actions.endSessionFinalPriceConfirm' | translate }}</span>
      </button>
    </div>
  </div>
</div>
